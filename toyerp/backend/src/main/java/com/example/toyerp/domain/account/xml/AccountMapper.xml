<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.toyerp.domain.account.mapper.AccountMapper">

  <resultMap id="AccountMap" type="com.example.toyerp.domain.account.vo.AccountVO">
    <id     property="id"      column="id"/>
    <result property="name"    column="name"/>
    <result property="type"    column="type"/>
    <result property="details" column="details"/>
  </resultMap>

  <!-- 공통 SELECT (Postgres 전용: ILIKE, enum 비교는 ::text) -->
  <sql id="BaseSelect">
    SELECT id, name, type::text AS type, details
    FROM account_subject
    <where>
      <if test="q != null and q != ''">
        (
          CAST(id AS TEXT) ILIKE CONCAT('%', #{q}, '%')
          OR name ILIKE CONCAT('%', #{q}, '%')
          OR details ILIKE CONCAT('%', #{q}, '%')
        )
      </if>
      <if test="type != null && type != ''">
        <if test="q != null && q != ''"> AND </if>
        type::text = #{type}
      </if>
    </where>
  </sql>

  <select id="selectAccounts" resultMap="AccountMap">
    <include refid="BaseSelect"/>
    ORDER BY id
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countAccounts" resultType="int">
    SELECT COUNT(1) FROM ( <include refid="BaseSelect"/> ) t
  </select>
</mapper>